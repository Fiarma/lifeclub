{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4 text-center">üìä Tableau de bord - Statistiques</h2>

    <!-- FILTRE DE P√âRIODE -->
    <div class="card p-3 mb-4 shadow-sm">
        <form method="get" class="row g-3 align-items-center">
            <div class="col-md-3">
                <label for="period" class="form-label">P√©riode :</label>
                <select name="period" id="period" class="form-select" onchange="this.form.submit()">
                    <option value="journalier" {% if period == 'journalier' %}selected{% endif %}>Journalier</option>
                    <option value="hebdomadaire" {% if period == 'hebdomadaire' %}selected{% endif %}>Hebdomadaire</option>
                    <option value="mensuel" {% if period == 'mensuel' %}selected{% endif %}>Mensuel</option>
                    <option value="trimestriel" {% if period == 'trimestriel' %}selected{% endif %}>Trimestriel</option>
                    <option value="annuel" {% if period == 'annuel' %}selected{% endif %}>Annuel</option>
                </select>
            </div>

            {% if available_years %}
            <div class="col-md-2">
                <label for="year" class="form-label">Ann√©e :</label>
                <select name="year" id="year" class="form-select" onchange="this.form.submit()">
                    {% for year in available_years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            {% if period == "hebdomadaire" or period == "mensuel" %}
            <div class="col-md-2">
                <label for="month" class="form-label">Mois :</label>
                <select name="month" id="month" class="form-select" onchange="this.form.submit()">
                    {% for month_number, month_name in months %}
                        <option value="{{ month_number }}" {% if month_number == selected_month %}selected{% endif %}>{{ month_name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            {% if period == "journalier" %}
            <div class="col-md-3">
                <label for="date" class="form-label">Date :</label>
                <input type="date" name="date" id="date" value="{{ selected_date }}" class="form-control" onchange="this.form.submit()">
            </div>
            {% endif %}
        </form>
    </div>

    <div class="row">
        <!-- 1Ô∏è‚É£ CHIFFRE D'AFFAIRES / D√âPENSES / AVANCES -->
        <div class="col-md-12 mb-5">
            <div class="card p-4 shadow-sm">
                <h4 class="card-title mb-3">1Ô∏è‚É£ √âvolution du Chiffre d'Affaires, D√©penses et Avances</h4>
                <div class="mb-3 d-flex flex-wrap">
                    <button class="btn btn-sm btn-outline-primary me-2 mb-2" onclick="toggleTrace('ca')">CA</button>
                    <button class="btn btn-sm btn-outline-danger me-2 mb-2" onclick="toggleTrace('depenses')">D√©penses</button>
                    <button class="btn btn-sm btn-outline-warning me-2 mb-2" onclick="toggleTrace('avances')">Avances</button>
                    <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="toggleAllTraces()">Tout Afficher</button>
                </div>
                <div id="caChart" style="width:100%; height:400px;"></div>
            </div>
        </div>

        <!-- 2Ô∏è‚É£ QUANTIT√â DE BOISSONS -->
        <div class="col-md-6 mb-5">
            <div class="card p-4 shadow-sm">
                <h4 class="card-title">2Ô∏è‚É£ Quantit√© de Boissons Vendues</h4>
                <div id="boissonQuantiteChart" style="width:100%; height:400px;"></div>
            </div>
        </div>

        <!-- 3Ô∏è‚É£ VENTES PAR PERSONNEL ET BOISSON -->
        <div class="col-md-6 mb-5">
            <div class="card p-4 shadow-sm">
                <h4 class="card-title">3Ô∏è‚É£ Ventes par Personnel et Boisson</h4>
                <p class="text-muted small">Chaque couleur repr√©sente un employ√©. Les barres montrent la quantit√© vendue par boisson.</p>
                <div id="personnelBoissonChart" style="width:100%; height:400px;"></div>
            </div>
        </div>

        <!-- 4Ô∏è‚É£ QUANTIT√â TOTALE PAR PERSONNEL -->
        <div class="col-md-6 mb-5">
            <div class="card p-4 shadow-sm">
                <h4 class="card-title">4Ô∏è‚É£ Quantit√© Totale Vendue par Personnel</h4>
                <div id="personnelTotalChart" style="width:100%; height:400px;"></div>
            </div>
        </div>

        <!-- 5Ô∏è‚É£ TOP 10 CLIENTS -->
        <div class="col-md-6 mb-5">
            <div class="card p-4 shadow-sm">
                <h4 class="card-title">5Ô∏è‚É£ Top 10 Clients (Montant total d√©pens√©)</h4>
                <div id="topClientsChart" style="width:100%; height:400px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- PLOTLY.JS -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- R√©cup√©ration des donn√©es JSON depuis Django ---
    const caLabels = JSON.parse('{{ ca_labels|safe }}');
    const caData = {
        ca: JSON.parse('{{ ca_data|safe }}'),
        depenses: JSON.parse('{{ depenses_data|safe }}'),
        avances: JSON.parse('{{ avances_data|safe }}')
    };
    const boissonsLabels = JSON.parse('{{ boissons_labels|safe }}');
    const boissonsData = JSON.parse('{{ boissons_data|safe }}');
    const personnelBoissonLabels = JSON.parse('{{ personnel_boisson_labels|safe }}');
    const personnelBoissonDatasets = JSON.parse('{{ personnel_boisson_datasets|safe }}');
    const personnelTotalLabels = JSON.parse('{{ personnel_total_labels|safe }}');
    const personnelTotalData = JSON.parse('{{ personnel_total_data|safe }}');
    const topClientsLabels = JSON.parse('{{ top_clients_labels|safe }}');
    const topClientsData = JSON.parse('{{ top_clients_data|safe }}');

    // --- G√©n√©ration automatique de couleurs distinctes ---
    function generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(`hsl(${i * (360 / count)}, 70%, 50%)`);
        }
        return colors;
    }

    // Variables globales pour les graphiques
    let caChartPlotly;

    // 1Ô∏è‚É£ √âvolution CA / D√©penses / Avances
    const caTraces = [
        {
            x: caLabels,
            y: caData.ca,
            type: 'scatter',
            mode: 'lines+markers',
            name: "Chiffre d'Affaires (F)",
            line: { color: '#007bff', width: 3 },
            marker: { size: 6 }
        },
        {
            x: caLabels,
            y: caData.depenses,
            type: 'scatter',
            mode: 'lines+markers',
            name: "D√©penses (F)",
            line: { color: '#dc3545', width: 3 },
            marker: { size: 6 },
            visible: 'legendonly'
        },
        {
            x: caLabels,
            y: caData.avances,
            type: 'scatter',
            mode: 'lines+markers',
            name: "Avances (F)",
            line: { color: '#ffc107', width: 3 },
            marker: { size: 6 },
            visible: 'legendonly'
        }
    ];

    const caLayout = {
        title: { text: '√âvolution des Flux Financiers', font: { size: 16 } },
        xaxis: { title: 'P√©riode' },
        yaxis: { title: 'Montant (FCFA)', rangemode: 'tozero' },
        hovermode: 'closest',
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 }
    };

    caChartPlotly = Plotly.newPlot('caChart', caTraces, caLayout, { responsive: true });

    // Fonctions pour g√©rer l'affichage des traces
    window.toggleTrace = function(traceName) {
        const traces = {
            'ca': 0,
            'depenses': 1,
            'avances': 2
        };
        
        const traceIndex = traces[traceName];
        if (traceIndex !== undefined) {
            const currentVisibility = caTraces[traceIndex].visible;
            const newVisibility = currentVisibility === 'legendonly' ? true : 'legendonly';
            
            Plotly.restyle('caChart', { visible: newVisibility }, [traceIndex]);
        }
    };

    window.toggleAllTraces = function() {
        Plotly.restyle('caChart', { visible: true }, [0, 1, 2]);
    };

    // 2Ô∏è‚É£ Quantit√© de Boissons (Barres horizontales)
    const boissonTrace = {
        x: boissonsData,
        y: boissonsLabels,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: generateColors(boissonsLabels.length),
            line: { color: 'rgba(0,0,0,0.3)', width: 1 }
        }
    };

    const boissonLayout = {
        title: { text: 'Quantit√© de Boissons Vendues', font: { size: 14 } },
        xaxis: { title: 'Quantit√©' },
        yaxis: { title: 'Boissons', automargin: true },
        margin: { l: 150, r: 50, t: 50, b: 50 }
    };

    Plotly.newPlot('boissonQuantiteChart', [boissonTrace], boissonLayout, { responsive: true });

    // 3Ô∏è‚É£ Ventes par Personnel et Boisson (Barres group√©es)
    const personnelBoissonTraces = personnelBoissonDatasets.map((dataset, index) => {
        return {
            x: personnelBoissonLabels,
            y: dataset.data,
            type: 'bar',
            name: dataset.label,
            marker: { color: generateColors(personnelBoissonDatasets.length)[index] }
        };
    });

    const personnelBoissonLayout = {
        title: { text: 'Ventes par Personnel et Boisson', font: { size: 14 } },
        xaxis: { title: 'Boissons' },
        yaxis: { title: 'Quantit√© Vendue', rangemode: 'tozero' },
        barmode: 'group',
        showlegend: true,
        legend: { orientation: 'h', y: -0.2 }
    };

    Plotly.newPlot('personnelBoissonChart', personnelBoissonTraces, personnelBoissonLayout, { responsive: true });

    // 4Ô∏è‚É£ Quantit√© Totale Vendue par Personnel (Barres horizontales)
    const personnelTotalTrace = {
        x: personnelTotalData,
        y: personnelTotalLabels,
        type: 'bar',
        orientation: 'h',
        marker: {
            color: generateColors(personnelTotalLabels.length),
            line: { color: 'rgba(0,0,0,0.3)', width: 1 }
        }
    };

    const personnelTotalLayout = {
        title: { text: 'Quantit√© Totale par Personnel', font: { size: 14 } },
        xaxis: { title: 'Quantit√©' },
        yaxis: { title: 'Personnel', automargin: true },
        margin: { l: 150, r: 50, t: 50, b: 50 }
    };

    Plotly.newPlot('personnelTotalChart', [personnelTotalTrace], personnelTotalLayout, { responsive: true });

    // 5Ô∏è‚É£ Top 10 Clients (Camembert)
    const topClientsTrace = {
        labels: topClientsLabels,
        values: topClientsData,
        type: 'pie',
        hole: 0.4,
        marker: { colors: generateColors(topClientsLabels.length) },
        textinfo: 'label+percent',
        hoverinfo: 'label+value+percent',
        textposition: 'outside'
    };

    const topClientsLayout = {
        title: { text: 'Top 10 Clients', font: { size: 14 } },
        showlegend: true,
        legend: { orientation: 'v' }
    };

    Plotly.newPlot('topClientsChart', [topClientsTrace], topClientsLayout, { responsive: true });

    // Redimensionnement responsive
    window.addEventListener('resize', function() {
        Plotly.Plots.resize('caChart');
        Plotly.Plots.resize('boissonQuantiteChart');
        Plotly.Plots.resize('personnelBoissonChart');
        Plotly.Plots.resize('personnelTotalChart');
        Plotly.Plots.resize('topClientsChart');
    });
});
</script>
{% endblock %}