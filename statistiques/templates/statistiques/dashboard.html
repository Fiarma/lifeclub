
{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="container-fluid">
<div class="row">
<div class="col-12 px-4">
<!-- En-tête avec titre -->
<div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
<h2 class="h2 mb-0">Tableau de Bord Complet</h2>
</div>

<!-- Section Filtres de période -->
<div class="card mb-4">
<div class="card-body">
<h5 class="card-title">Période d'Analyse</h5>

<form method="get" id="filter-form">
<input type="hidden" name="graph" id="current-graph" value="{{ current_graph|default:'financial' }}">

<!-- Périodes sur une seule ligne horizontale -->
<div class="mb-3">
<div class="d-flex flex-wrap gap-3 align-items-center">
<div class="form-check">
<input class="form-check-input" type="radio" name="period" id="radio-aujourdhui" value="aujourdhui"
{% if period == 'aujourdhui' %}checked{% endif %} onchange="toggleDateFields('aujourdhui')">
<label class="form-check-label" for="radio-aujourdhui">
Aujourd'hui
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="period" id="radio-journalier" value="journalier"
{% if period == 'journalier' %}checked{% endif %} onchange="toggleDateFields('journalier')">
<label class="form-check-label" for="radio-journalier">
Journalier
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="period" id="radio-hebdomadaire" value="hebdomadaire"
{% if period == 'hebdomadaire' %}checked{% endif %} onchange="toggleDateFields('hebdomadaire')">
<label class="form-check-label" for="radio-hebdomadaire">
Hebdomadaire
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="period" id="radio-mensuel" value="mensuel"
{% if period == 'mensuel' %}checked{% endif %} onchange="toggleDateFields('mensuel')">
<label class="form-check-label" for="radio-mensuel">
Mensuel
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="period" id="radio-trimestriel" value="trimestriel"
{% if period == 'trimestriel' %}checked{% endif %} onchange="toggleDateFields('trimestriel')">
<label class="form-check-label" for="radio-trimestriel">
Trimestriel
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="period" id="radio-annuel" value="annuel"
{% if period == 'annuel' %}checked{% endif %} onchange="toggleDateFields('annuel')">
<label class="form-check-label" for="radio-annuel">
Annuel
</label>
</div>
<div class="form-check">
<input class="form-check-input" type="radio" name="period" id="radio-autre" value="autre"
{% if period == 'autre' %}checked{% endif %} onchange="toggleDateFields('autre')">
<label class="form-check-label" for="radio-autre">
Autre
</label>
</div>
</div>
</div>

<!-- Champ Date Journalier -->
<div id="field-journalier" class="mb-3" style="display: none;">
<div class="row">
<div class="col-md-3">
<label for="date-input" class="form-label">Date</label>
<input type="date" name="date" id="date-input" class="form-control" value="{{ selected_date }}">
</div>
</div>
</div>

<!-- Champs Date Début/Fin pour Autre -->
<div id="fields-autre" class="mb-3" style="display: none;">
<div class="row">
<div class="col-md-3">
<label for="start-date-input" class="form-label">Date de début</label>
<input type="date" name="start_date" id="start-date-input" class="form-control" value="{{ start_date_param }}">
</div>
<div class="col-md-3">
<label for="end-date-input" class="form-label">Date de fin</label>
<input type="date" name="end_date" id="end-date-input" class="form-control" value="{{ end_date_param }}">
</div>
</div>
</div>

<div class="row align-items-end">
<div class="col-md-6">
<button type="submit" class="btn btn-primary">
<i class="fas fa-check-circle me-1"></i>
Valider et Générer
</button>
</div>
<div class="col-md-6">
<div class="text-muted fw-bold" id="period-display">
<!-- Affichage de la période sera mis à jour par JavaScript -->
</div>
</div>
</div>
</form>
</div>
</div>

<!-- Tous les graphiques visibles en même temps -->
<div class="row">
<!-- Graphique Répartition Financière -->
<div class="col-12 col-lg-6 mb-4">
<div class="card shadow-sm">
<div class="card-body">
<h5 class="card-title">Répartition du Chiffre d'Affaires</h5>
<div id="caChart" style="width:100%; height:400px;"></div>
</div>
</div>
</div>

<!-- Graphique Répartition Marge -->
<div class="col-12 col-lg-6 mb-4">
<div class="card shadow-sm">
<div class="card-body">
<h5 class="card-title">Répartition de la Marge</h5>
<div id="margeChart" style="width:100%; height:400px;"></div>
</div>
</div>
</div>

<!-- Performance des Produits - Quantité -->
<div class="col-12 col-lg-6 mb-4">
<div class="card shadow-sm">
<div class="card-body">
<h5 class="card-title">Performance des Produits (Quantité)</h5>
<p class="text-muted">Top 10 des produits les plus vendus par quantité</p>
<div id="produitsQuantiteChart" style="width:100%; height:400px;"></div>
</div>
</div>
</div>

<!-- Performance des Produits - Marge -->
<div class="col-12 col-lg-6 mb-4">
<div class="card shadow-sm">
<div class="card-body">
<h5 class="card-title">Performance des Produits (Marge)</h5>
<p class="text-muted">Répartition de la marge par produit</p>
<div id="produitsMargeChart" style="width:100%; height:400px;"></div>
</div>
</div>
</div>

<!-- Performance du Personnel - Quantité -->
<div class="col-12 col-lg-6 mb-4">
<div class="card shadow-sm">
<div class="card-body">
<h5 class="card-title">Performance du Personnel (Quantité)</h5>
<p class="text-muted">Top 10 du personnel par quantité vendue</p>
<div id="personnelQuantiteChart" style="width:100%; height:400px;"></div>
</div>
</div>
</div>

<!-- Performance du Personnel - Marge -->
<div class="col-12 col-lg-6 mb-4">
<div class="card shadow-sm">
<div class="card-body">
<h5 class="card-title">Performance du Personnel (Marge)</h5>
<p class="text-muted">Répartition de la marge par personnel</p>
<div id="personnelMargeChart" style="width:100%; height:400px;"></div>
</div>
</div>
</div>

<!-- Graphique Top Clients -->
<div class="col-12 mb-4">
<div class="card shadow-sm">
<div class="card-body">
<h5 class="card-title">Top 10 Clients</h5>
<p class="text-muted">Clients ayant dépensé le plus</p>
<div id="topClientsChart" style="width:100%; height:500px;"></div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
/* Cacher la barre d'outils Plotly pour le camembert */
.no-plotly-bar .modebar {
display: none !important;
}

/* Style pour les radios en ligne */
.d-flex.flex-wrap.gap-3 .form-check {
margin-bottom: 0;
}

/* Style pour les messages de données vides */
.no-data-message {
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100%;
color: #6c757d;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Fonction de gestion des champs de date ---
    window.toggleDateFields = function(selectedPeriod) {
        const journalierField = document.getElementById('field-journalier');
        const autreFields = document.getElementById('fields-autre');

        // Cacher tous les champs conditionnels par défaut
        journalierField.style.display = 'none';
        autreFields.style.display = 'none';

        // Afficher les champs appropriés
        if (selectedPeriod === 'journalier') {
            journalierField.style.display = 'block';
        } else if (selectedPeriod === 'autre') {
            autreFields.style.display = 'block';
        }

        // Mettre à jour l'affichage de la période
        updatePeriodDisplay(selectedPeriod);
    }

    // --- Fonction pour mettre à jour l'affichage de la période ---
    function updatePeriodDisplay(period) {
        const periodDisplay = document.getElementById('period-display');
        let displayText = '';

        switch(period) {
            case 'aujourdhui':
                displayText = 'Statistiques du jour';
                break;
            case 'journalier':
                const dateInput = document.getElementById('date-input');
                if (dateInput && dateInput.value) {
                    const dateObj = new Date(dateInput.value);
                    displayText = `Statistiques du ${dateObj.toLocaleDateString('fr-FR')}`;
                } else {
                    displayText = 'Statistiques journalières';
                }
                break;
            case 'autre':
                const startInput = document.getElementById('start-date-input');
                const endInput = document.getElementById('end-date-input');
                if (startInput && endInput && startInput.value && endInput.value) {
                    const startDate = new Date(startInput.value);
                    const endDate = new Date(endInput.value);
                    displayText = `Statistiques du ${startDate.toLocaleDateString('fr-FR')} au ${endDate.toLocaleDateString('fr-FR')}`;
                } else {
                    displayText = 'Statistiques sur période personnalisée';
                }
                break;
            case 'hebdomadaire':
                displayText = 'Statistiques de la semaine en cours';
                break;
            case 'mensuel':
                displayText = 'Statistiques du mois en cours';
                break;
            case 'trimestriel':
                displayText = 'Statistiques du trimestre en cours';
                break;
            case 'annuel':
                displayText = 'Statistiques de l\'année en cours';
                break;
            default:
                displayText = 'Statistiques';
        }

        periodDisplay.textContent = displayText;
    }

    // --- Initialisation de l'affichage au chargement ---
    const initialRadio = document.querySelector('input[name="period"]:checked');
    if (initialRadio) {
        toggleDateFields(initialRadio.value);
    } else {
        toggleDateFields('mensuel');
    }

    // --- Écouteurs d'événements pour les champs de date ---
    document.getElementById('date-input')?.addEventListener('change', function() {
        updatePeriodDisplay('journalier');
    });

    document.getElementById('start-date-input')?.addEventListener('change', function() {
        updatePeriodDisplay('autre');
    });

    document.getElementById('end-date-input')?.addEventListener('change', function() {
        updatePeriodDisplay('autre');
    });

    // --- Récupération des données JSON depuis Django ---
    const caData = {
        ca: JSON.parse('{{ ca_data|safe }}'),
        impayes: JSON.parse('{{ impayes_data|safe }}'),
        depenses: JSON.parse('{{ depenses_data|safe }}'),
        avances: JSON.parse('{{ avances_data|safe }}')
    };
    
    const margeData = {
        marge: JSON.parse('{{ marge_data|safe }}'),
        benefice: JSON.parse('{{ benefice_data|safe }}'),
        depenses: JSON.parse('{{ depenses_data|safe }}')
    };

    const produitsQuantiteLabels = JSON.parse('{{ produits_quantite_labels|safe }}');
    const produitsQuantiteData = JSON.parse('{{ produits_quantite_data|safe }}');
    const produitsMargeLabels = JSON.parse('{{ produits_marge_labels|safe }}');
    const produitsMargeData = JSON.parse('{{ produits_marge_data|safe }}');
    
    const personnelQuantiteLabels = JSON.parse('{{ personnel_quantite_labels|safe }}');
    const personnelQuantiteData = JSON.parse('{{ personnel_quantite_data|safe }}');
    const personnelMargeLabels = JSON.parse('{{ personnel_marge_labels|safe }}');
    const personnelMargeData = JSON.parse('{{ personnel_marge_data|safe }}');
    
    const topClientsLabels = JSON.parse('{{ top_clients_labels|safe }}');
    const topClientsData = JSON.parse('{{ top_clients_data|safe }}');

    // Fonction de génération de couleurs
    function generateColors(count) {
        const colors = [];
        for (let i = 0; i < count; i++) {
            colors.push(`hsl(${i * (360 / count)}, 70%, 50%)`);
        }
        return colors;
    }

    // Fonction pour vérifier et initialiser les graphiques avec des données par défaut si nécessaire
    function safeInitializeChart(chartId, data, labels, chartType, title) {
        if (!data || data.length === 0 || !labels || labels.length === 0 || data.every(val => val === 0)) {
            // Afficher un message si pas de données
            document.getElementById(chartId).innerHTML = `
                <div class="no-data-message">
                    <i class="fas fa-chart-bar fa-3x mb-3"></i>
                    <p class="text-muted">Aucune donnée disponible pour ${title}</p>
                    <small>Veuillez sélectionner une autre période ou vérifier les données</small>
                </div>
            `;
            return false;
        }
        
        return true;
    }

    // 1️⃣ GRAPHIQUE RÉPARTITION CHIFFRE D'AFFAIRES
    function initializeCAChart() {
        const totalCA = caData.ca.reduce((sum, value) => sum + value, 0);
        const totalImpayes = caData.impayes.reduce((sum, value) => sum + value, 0);
        const totalDepenses = caData.depenses.reduce((sum, value) => sum + value, 0);
        const totalAvances = caData.avances.reduce((sum, value) => sum + value, 0);

        // Vérifier s'il y a des données
        if (totalCA === 0 && totalImpayes === 0 && totalDepenses === 0 && totalAvances === 0) {
            document.getElementById('caChart').innerHTML = `
                <div class="no-data-message">
                    <i class="fas fa-chart-pie fa-3x mb-3"></i>
                    <p class="text-muted">Aucune donnée financière disponible</p>
                    <small>Veuillez sélectionner une autre période</small>
                </div>
            `;
            return;
        }

        const caPieData = [{
            labels: ['Chiffre d\'Affaires', 'Impayés', 'Dépenses', 'Avances'],
            values: [totalCA, totalImpayes, totalDepenses, totalAvances],
            type: 'pie',
            hole: 0.4,
            marker: {
                colors: ['#28a745', '#dc3545', '#ffc107', '#17a2b8']
            },
            textinfo: 'percent',
            hoverinfo: 'label+value+percent',
            textposition: 'inside',
            hovertemplate: '<b>%{label}</b><br>Montant: %{value:,.0f} F<br>Pourcentage: %{percent}<extra></extra>',
            texttemplate: '%{percent}'
        }];

        const caPieLayout = {
            showlegend: true,
            legend: {
                orientation: 'h',
                y: -0.1,
                x: 0.5,
                xanchor: 'center'
            },
            margin: { t: 20, b: 50, l: 50, r: 50 },
            hovermode: 'closest'
        };

        Plotly.newPlot('caChart', caPieData, caPieLayout, {
            responsive: true,
            displayModeBar: false
        });

        document.getElementById('caChart').classList.add('no-plotly-bar');
    }

    // 2️⃣ GRAPHIQUE RÉPARTITION MARGE
    function initializeMargeChart() {
        const totalMarge = margeData.marge.reduce((sum, value) => sum + value, 0);
        const totalBenefice = margeData.benefice.reduce((sum, value) => sum + value, 0);
        const totalDepenses = margeData.depenses.reduce((sum, value) => sum + value, 0);

        // Vérifier s'il y a des données
        if (totalMarge === 0 && totalBenefice === 0 && totalDepenses === 0) {
            document.getElementById('margeChart').innerHTML = `
                <div class="no-data-message">
                    <i class="fas fa-chart-pie fa-3x mb-3"></i>
                    <p class="text-muted">Aucune donnée de marge disponible</p>
                    <small>Veuillez sélectionner une autre période</small>
                </div>
            `;
            return;
        }

        const margePieData = [{
            labels: ['Marge Totale', 'Dépenses', 'Bénéfice Net'],
            values: [totalMarge, totalDepenses, totalBenefice],
            type: 'pie',
            hole: 0.4,
            marker: {
                colors: ['#6610f2', '#fd7e14', '#20c997']
            },
            textinfo: 'percent',
            hoverinfo: 'label+value+percent',
            textposition: 'inside',
            hovertemplate: '<b>%{label}</b><br>Montant: %{value:,.0f} F<br>Pourcentage: %{percent}<extra></extra>',
            texttemplate: '%{percent}'
        }];

        const margePieLayout = {
            showlegend: true,
            legend: {
                orientation: 'h',
                y: -0.1,
                x: 0.5,
                xanchor: 'center'
            },
            margin: { t: 20, b: 50, l: 50, r: 50 },
            hovermode: 'closest'
        };

        Plotly.newPlot('margeChart', margePieData, margePieLayout, {
            responsive: true,
            displayModeBar: false
        });

        document.getElementById('margeChart').classList.add('no-plotly-bar');
    }

    // 3️⃣ GRAPHIQUE PERFORMANCE PRODUITS - QUANTITÉ
    function initializeProduitsQuantiteChart() {
        const hasData = safeInitializeChart(
            'produitsQuantiteChart', 
            produitsQuantiteData, 
            produitsQuantiteLabels, 
            'bar', 
            'les produits par quantité'
        );
        
        if (!hasData) return;

        const produitsQuantiteTrace = {
            x: produitsQuantiteData, 
            y: produitsQuantiteLabels, 
            type: 'bar', 
            orientation: 'h',
            marker: { 
                color: generateColors(produitsQuantiteLabels.length), 
                line: { color: 'rgba(0,0,0,0.3)', width: 1 } 
            },
            hovertemplate: '<b>%{y}</b><br>Quantité: %{x}<extra></extra>'
        };

        const produitsQuantiteLayout = {
            xaxis: { title: 'Quantité Vendue' },
            yaxis: { title: 'Produits', automargin: true },
            margin: { l: 150, r: 50, t: 20, b: 50 }
        };

        Plotly.newPlot('produitsQuantiteChart', [produitsQuantiteTrace], produitsQuantiteLayout, {
            responsive: true,
            displayModeBar: true
        });
    }

    // 4️⃣ GRAPHIQUE PERFORMANCE PRODUITS - MARGE
    function initializeProduitsMargeChart() {
        const hasData = safeInitializeChart(
            'produitsMargeChart', 
            produitsMargeData, 
            produitsMargeLabels, 
            'pie', 
            'les produits par marge'
        );
        
        if (!hasData) return;

        const produitsMargeTrace = {
            labels: produitsMargeLabels,
            values: produitsMargeData,
            type: 'pie',
            hole: 0.3,
            marker: {
                colors: generateColors(produitsMargeLabels.length)
            },
            textinfo: 'percent+label',
            hoverinfo: 'label+value+percent',
            hovertemplate: '<b>%{label}</b><br>Marge: %{value:,.0f} F<br>Pourcentage: %{percent}<extra></extra>'
        };

        const produitsMargeLayout = {
            showlegend: true,
            legend: {
                orientation: 'v',
                y: 0.5,
                x: 1.1
            },
            margin: { t: 20, b: 50, l: 50, r: 150 },
            hovermode: 'closest'
        };

        Plotly.newPlot('produitsMargeChart', [produitsMargeTrace], produitsMargeLayout, {
            responsive: true,
            displayModeBar: false
        });
    }

    // 5️⃣ GRAPHIQUE PERFORMANCE PERSONNEL - QUANTITÉ
    function initializePersonnelQuantiteChart() {
        const hasData = safeInitializeChart(
            'personnelQuantiteChart', 
            personnelQuantiteData, 
            personnelQuantiteLabels, 
            'bar', 
            'le personnel par quantité'
        );
        
        if (!hasData) return;

        const personnelQuantiteTrace = {
            x: personnelQuantiteData, 
            y: personnelQuantiteLabels, 
            type: 'bar', 
            orientation: 'h',
            marker: { 
                color: generateColors(personnelQuantiteLabels.length), 
                line: { color: 'rgba(0,0,0,0.3)', width: 1 } 
            },
            hovertemplate: '<b>%{y}</b><br>Quantité: %{x}<extra></extra>'
        };

        const personnelQuantiteLayout = {
            xaxis: { title: 'Quantité Vendue' },
            yaxis: { title: 'Personnel', automargin: true },
            margin: { l: 150, r: 50, t: 20, b: 50 }
        };

        Plotly.newPlot('personnelQuantiteChart', [personnelQuantiteTrace], personnelQuantiteLayout, {
            responsive: true,
            displayModeBar: true
        });
    }

    // 6️⃣ GRAPHIQUE PERFORMANCE PERSONNEL - MARGE
    function initializePersonnelMargeChart() {
        const hasData = safeInitializeChart(
            'personnelMargeChart', 
            personnelMargeData, 
            personnelMargeLabels, 
            'pie', 
            'le personnel par marge'
        );
        
        if (!hasData) return;

        const personnelMargeTrace = {
            labels: personnelMargeLabels,
            values: personnelMargeData,
            type: 'pie',
            hole: 0.3,
            marker: {
                colors: generateColors(personnelMargeLabels.length)
            },
            textinfo: 'percent+label',
            hoverinfo: 'label+value+percent',
            hovertemplate: '<b>%{label}</b><br>Marge: %{value:,.0f} F<br>Pourcentage: %{percent}<extra></extra>'
        };

        const personnelMargeLayout = {
            showlegend: true,
            legend: {
                orientation: 'v',
                y: 0.5,
                x: 1.1
            },
            margin: { t: 20, b: 50, l: 50, r: 150 },
            hovermode: 'closest'
        };

        Plotly.newPlot('personnelMargeChart', [personnelMargeTrace], personnelMargeLayout, {
            responsive: true,
            displayModeBar: false
        });
    }

    // 7️⃣ GRAPHIQUE CLIENTS
    function initializeClientsChart() {
        const hasData = safeInitializeChart(
            'topClientsChart', 
            topClientsData, 
            topClientsLabels, 
            'bar', 
            'les clients'
        );
        
        if (!hasData) return;

        const formattedClientsLabels = topClientsLabels.map(label => String(label));

        const topClientsTrace = {
            x: topClientsData, 
            y: formattedClientsLabels, 
            type: 'bar', 
            orientation: 'h',
            marker: { 
                color: '#6f42c1', 
                line: { color: 'rgba(0,0,0,0.3)', width: 1 } 
            },
            hovertemplate: '<b>%{y}</b><br>Montant: %{x:,.0f} F<extra></extra>'
        };

        const topClientsLayout = {
            xaxis: { 
                title: 'Montant Dépensé (FCFA)', 
                tickformat: ',.0f', 
                showgrid: true 
            },
            yaxis: { 
                title: 'Clients', 
                automargin: true, 
                type: 'category' 
            },
            margin: { l: 250, r: 50, t: 20, b: 50 }
        };

        Plotly.newPlot('topClientsChart', [topClientsTrace], topClientsLayout, {
            responsive: true,
            displayModeBar: true
        });
    }

    // Initialiser tous les graphiques
    initializeCAChart();
    initializeMargeChart();
    initializeProduitsQuantiteChart();
    initializeProduitsMargeChart();
    initializePersonnelQuantiteChart();
    initializePersonnelMargeChart();
    initializeClientsChart();
});
</script>
{% endblock %}
"