{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h2>Ajouter une commande</h2>
  
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}

  <form method="post" id="form-ajout-commande">
    {% csrf_token %}

    <div class="mb-3">
      {{ form_commande.personnel.label_tag }}
      {{ form_commande.personnel }}
      {% if form_commande.personnel.errors %}
        <div class="text-danger small">{{ form_commande.personnel.errors }}</div>
      {% endif %}
    </div>

    <hr>
    
    <h4>Informations Client</h4>
    <p class="text-muted"><small>Le num√©ro de t√©l√©phone est obligatoire. L'indicatif üáßüá´ +226 est s√©lectionn√© par d√©faut.</small></p>

    <div class="row mb-3">
        <div class="col-md-6">
            <label for="{{ form_commande.numero_telephone.id_for_label }}">Num√©ro de t√©l√©phone du client :</label>
            <div class="input-group">
                {{ form_commande.code_pays_tel }} 
                {{ form_commande.numero_telephone }}
            </div>
            {% if form_commande.numero_telephone.errors %}
                <div class="text-danger small">{{ form_commande.numero_telephone.errors }}</div>
            {% endif %}
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col-md-6">
            {{ form_commande.client_prenom.label_tag }}
            {{ form_commande.client_prenom }}
            {% if form_commande.client_prenom.errors %}
                <div class="text-danger small">{{ form_commande.client_prenom.errors }}</div>
            {% endif %}
        </div>
        <div class="col-md-6">
            {{ form_commande.client_nom.label_tag }}
            {{ form_commande.client_nom }}
            {% if form_commande.client_nom.errors %}
                <div class="text-danger small">{{ form_commande.client_nom.errors }}</div>
            {% endif %}
        </div>
    </div>
    <hr>

    <h4>Articles de la commande</h4>
    <div id="items-container">
      <div class="item-row mb-2 d-flex align-items-center gap-2">
        <select name="produit" class="form-select w-50 produit-select" required>
          <option value="">S√©lectionnez un produit</option>
          {% for p in produits %}
            <option value="{{ p.id }}" 
                    data-stock="{{ p.stock_actuel|default_if_none:'‚àû' }}"
                    data-nature="{{ p.nature }}"
                    {% if p.nature == 'denombrable' and p.stock_actuel <= 0 %}disabled{% endif %}>
              {{ p.nom }} ‚Äî {{ p.prix_vente }} F 
              {% if p.nature == 'denombrable' %}
                {% if p.stock_actuel <= 0 %}(√âPUIS√â){% else %}(Stock: {{ p.stock_actuel }}){% endif %}
              {% else %}
                (Non d√©nombrable)
              {% endif %}
            </option>
          {% endfor %}
        </select>

        <input type="number" name="quantite" class="form-control w-25" placeholder="Quantit√©" min="1" value="1" required>

        <button type="button" class="btn btn-danger remove-item flex-shrink-0">Supprimer</button>
      </div>
    </div>

    <div class="mt-3">
      <button type="button" class="btn btn-secondary" id="add-item">Ajouter un produit</button>
      <button type="submit" class="btn btn-primary">Enregistrer la commande</button>
    </div>
  </form>
</div>

<div id="stock-display" style="
    position: fixed;
    top: 20px;
    right: 20px;
    width: 150px;
    min-height: 100px;
    background-color: #007bff;
    color: white;
    border-radius: 10px;
    padding: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    display: none;
    z-index: 1000;
    font-family: Arial, sans-serif;
    text-align: center;
    pointer-events: none;
">
    <strong id="stock-produit-nom" style="font-size: 1.1em; display: block; margin-bottom: 5px;"></strong>
    <span style="font-size: 0.8em; display: block;">Stock Actuel:</span>
    <span id="stock-produit-quantite" style="font-size: 2em; font-weight: bold;"></span>
</div>

<script>
  // ===============================================
  // GESTION DU CERCLE DE STOCK
  // ===============================================

  const stockDisplay = document.getElementById('stock-display');
  const stockNom = document.getElementById('stock-produit-nom');
  const stockQuantite = document.getElementById('stock-produit-quantite');

  /**
   * Affiche le cercle de stock et met √† jour les informations.
   */
  function displayStock(nom, stock, nature) {
      stockNom.textContent = nom;
      
      // Afficher "‚àû" pour les produits non d√©nombrables
      if (nature === 'non_denombrable' || stock === '‚àû') {
          stockQuantite.textContent = '‚àû';
          stockDisplay.style.backgroundColor = '#28a745'; // Vert pour non d√©nombrable
      } else {
          stockQuantite.textContent = stock;
          const stockInt = parseInt(stock);
          
          // Mettre √† jour la couleur d'alerte pour les d√©nombrables
          if (stockInt <= 5 && stockInt > 0) {
              stockDisplay.style.backgroundColor = '#ffc107'; // Jaune (faible)
          } else if (stockInt === 0) {
              stockDisplay.style.backgroundColor = '#dc3545'; // Rouge (√©puis√©)
          } else {
              stockDisplay.style.backgroundColor = '#007bff'; // Bleu (normal)
          }
      }
      
      stockDisplay.style.display = 'block';
  }

  /**
   * √âcouteur d√©clench√© lors de la s√©lection d'une option.
   */
  function handleProduitChange() {
      const selectedOption = this.options[this.selectedIndex];
      const stock = selectedOption.getAttribute('data-stock');
      const nature = selectedOption.getAttribute('data-nature');
      const nom = selectedOption.textContent.split('‚Äî')[0].trim();

      if (stock !== null && this.value !== "") {
          displayStock(nom, stock, nature);
      } else {
          stockDisplay.style.display = 'none';
      }
  }

  // ===============================================
  // GESTION DYNAMIQUE DES LIGNES
  // ===============================================
  
  // Template HTML pour les nouvelles lignes
  const itemRowTemplate = `
      <div class="item-row mb-2 d-flex align-items-center gap-2">
        <select name="produit" class="form-select w-50 produit-select" required>
          <option value="">S√©lectionnez un produit</option>
          {% for p in produits %}
            <option value="{{ p.id }}" 
                    data-stock="{{ p.stock_actuel|default_if_none:'‚àû' }}"
                    data-nature="{{ p.nature }}"
                    {% if p.nature == 'denombrable' and p.stock_actuel <= 0 %}disabled{% endif %}>
              {{ p.nom }} ‚Äî {{ p.prix_vente }} F 
              {% if p.nature == 'denombrable' %}
                {% if p.stock_actuel <= 0 %}(√âPUIS√â){% else %}(Stock: {{ p.stock_actuel }}){% endif %}
              {% else %}
                (Non d√©nombrable)
              {% endif %}
            </option>
          {% endfor %}
        </select>
        <input type="number" name="quantite" class="form-control w-25" placeholder="Quantit√©" min="1" value="1" required>
        <button type="button" class="btn btn-danger remove-item flex-shrink-0">Supprimer</button>
      </div>
  `;
  
  /**
   * Attache les √©couteurs d'√©v√©nements √† un √©l√©ment de ligne
   */
  function attachListeners(element) {
      const select = element.querySelector('.produit-select');
      const btnRemove = element.querySelector('.remove-item');

      // Attacher l'√©couteur de changement pour le cercle de stock
      if (select) {
          select.addEventListener('change', handleProduitChange);
      }

      // Attacher l'√©couteur de suppression
      if (btnRemove) {
          btnRemove.addEventListener('click', function () {
              const container = document.getElementById('items-container');
              const rows = container.querySelectorAll('.item-row');
              
              // Ne supprimer la ligne que s'il y a plus d'une
              if (rows.length > 1) {
                  element.remove();
                  stockDisplay.style.display = 'none'; // Cacher le cercle apr√®s suppression
              } else {
                  alert("Vous devez avoir au moins un produit dans la commande.");
              }
          });
      }
  }
  
  /**
   * Clone une nouvelle ligne de produit
   */
  function cloneItemRow() {
    const container = document.getElementById('items-container');
    
    // Cr√©er un √©l√©ment √† partir du template HTML
    const newRow = document.createElement('div');
    newRow.innerHTML = itemRowTemplate.trim();
    const clone = newRow.firstChild;
    
    // Remettre √† z√©ro les champs
    const select = clone.querySelector('select');
    const input = clone.querySelector('input[name="quantite"]');
    if (select) select.value = '';
    if (input) input.value = 1;
    
    // Attacher les √©couteurs sur le clone
    attachListeners(clone);
    
    // Ajouter le clone au DOM
    container.appendChild(clone);
  }

  /**
   * Valide le formulaire avant soumission
   */
  function validateForm() {
      const selects = document.querySelectorAll('select[name="produit"]');
      let hasValidProduct = false;
      
      selects.forEach(select => { 
          const optionSelected = select.options[select.selectedIndex];
          const nature = optionSelected.getAttribute('data-nature');
          
          // V√©rifie si un produit est s√©lectionn√©
          if (select.value) {
              // Pour les produits d√©nombrables, v√©rifier qu'ils ne sont pas d√©sactiv√©s (√©puis√©s)
              if (nature === 'denombrable' && optionSelected.disabled) {
                  alert('Certains produits d√©nombrables s√©lectionn√©s sont √©puis√©s.');
                  return false;
              }
              hasValidProduct = true; 
          }
      });
      
      if (!hasValidProduct) {
          alert('Veuillez s√©lectionner au moins un produit.');
          return false;
      }
      
      // V√©rifier que toutes les quantit√©s sont valides
      const quantites = document.querySelectorAll('input[name="quantite"]');
      for (let input of quantites) {
          if (input.value < 1) {
              alert('Les quantit√©s doivent √™tre au moins de 1.');
              input.focus();
              return false;
          }
      }
      
      return true;
  }

  // ===============================================
  // INITIALISATION AU CHARGEMENT DE LA PAGE
  // ===============================================
  document.addEventListener('DOMContentLoaded', function() {
    // 1. Initialiser les √©couteurs sur les lignes existantes au chargement
    document.querySelectorAll('.item-row').forEach(row => {
        attachListeners(row);
    });
    
    // 2. Attacher l'√©v√©nement au bouton "Ajouter un produit"
    document.getElementById('add-item').addEventListener('click', cloneItemRow);
    
    // 3. Validation avant soumission du formulaire
    document.getElementById('form-ajout-commande').addEventListener('submit', function (e) {
      if (!validateForm()) {
        e.preventDefault();
      }
    });

    // 4. Afficher le stock pour le premier produit si d√©j√† s√©lectionn√©
    const firstSelect = document.querySelector('.produit-select');
    if (firstSelect && firstSelect.value) {
        handleProduitChange.call(firstSelect);
    }
  });
</script>

<style>
  .item-row {
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 5px;
      background-color: #f8f9fa;
  }
  
  .remove-item {
      transition: all 0.3s ease;
  }
  
  .remove-item:hover {
      transform: scale(1.05);
  }
</style>
{% endblock %}