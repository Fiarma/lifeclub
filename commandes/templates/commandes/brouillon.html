{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Liste des commandes</h2>

  {% for commande in commandes %}
  <div class="card mb-3 p-3 shadow-sm">
    <h5>Commande #{{ commande.id }} - {{ commande.personnel }}</h5>
    <p>
      <strong>Statut :</strong> 
      <span id="statut-{{ commande.id }}">
        {{ commande.get_statut_display }}
      </span>
    </p>

    <!-- Liste des boissons -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Boisson</th>
          <th>Quantité</th>
          <th>Montant</th>
        </tr>
      </thead>
      <tbody>
        {% for item in commande.items.all %}
        <tr id="item-row-{{ item.id }}">
          <td>{{ item.boisson.nom }}</td>
          <td>
            <button class="btn btn-sm btn-secondary"
                    onclick="updateQuantity({{ item.id }}, 'decrement')">-</button>
            <span id="item-quantite-{{ item.id }}">{{ item.quantite }}</span>
            <button class="btn btn-sm btn-secondary"
                    onclick="updateQuantity({{ item.id }}, 'increment')">+</button>
          </td>
          <td><span id="item-montant-{{ item.id }}">{{ item.montant_boisson }}</span> F</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p><strong>Total :</strong> <span id="commande-total-{{ commande.id }}">{{ commande.montant_total }}</span> F</p>

    <!-- Paiement -->
    <label>Type de paiement :</label>
    <select id="type-paiement-{{ commande.id }}" class="form-select"
            onchange="togglePaiementFields({{ commande.id }})">
      <option value="">-- Choisir --</option>
      <option value="liquidite">Liquidité</option>
      <option value="orange_money">Orange Money</option>
      <option value="hybride">Hybride</option>
    </select>

    <div id="paiement-fields-{{ commande.id }}" class="mt-2"></div>

    <button class="btn btn-success mt-3"
            onclick="validerCommande({{ commande.id }})">Valider</button>
  </div>
  {% empty %}
  <p>Aucune commande pour le moment.</p>
  {% endfor %}
</div>

<script>
  function updateQuantity(itemId, action) {
    fetch(`/commandes/update-item/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (data.deleted) {
          document.getElementById(`item-row-${data.item_id}`).remove();
        } else {
          document.getElementById(`item-quantite-${data.item_id}`).innerText = data.quantite;
          document.getElementById(`item-montant-${data.item_id}`).innerText = data.item_montant;
        }
        document.getElementById(`commande-total-${data.commande_id}`).innerText = data.commande_total;
      }
    });
  }

  function togglePaiementFields(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const container = document.getElementById(`paiement-fields-${commandeId}`);
    const total = parseFloat(document.getElementById(`commande-total-${commandeId}`).innerText);

    container.innerHTML = "";

    if (type === "liquidite") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité" 
               oninput="checkMonnaie(${commandeId}, ${total})">
        <div id="monnaie-section-${commandeId}" class="mt-2" style="display:none;">
          <p><strong>Monnaie :</strong> <span id="monnaie-${commandeId}">0</span> F</p>
          <label>Status monnaie :</label>
          <select id="status-monnaie-${commandeId}" class="form-select">
            <option value="remis">Remis</option>
            <option value="avoir">Avoir</option>
          </select>
        </div>
      `;
    } else if (type === "orange_money") {
      // Affiche le montant exact en lecture seule
      container.innerHTML = `
        <p><strong>Montant Orange Money :</strong> ${total} F</p>
      `;
    } else if (type === "hybride") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité"
               oninput="updateOrangeHybride(${commandeId}, ${total})">
        <p><strong>Montant Orange Money :</strong> <span id="orange-${commandeId}">${total}</span> F</p>
      `;
      // Initialise le champ Orange Money
      updateOrangeHybride(commandeId, total);
    }
  }

  function checkMonnaie(commandeId, total) {
    const montant = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const monnaieSection = document.getElementById(`monnaie-section-${commandeId}`);
    const monnaieField = document.getElementById(`monnaie-${commandeId}`);

    if (montant > total) {
      monnaieSection.style.display = "block";
      monnaieField.innerText = (montant - total).toFixed(0);
    } else {
      monnaieSection.style.display = "none";
      monnaieField.innerText = 0;
    }
  }

  function updateOrangeHybride(commandeId, total) {
    const liquidite = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const orange = Math.max(total - liquidite, 0);
    document.getElementById(`orange-${commandeId}`).innerText = orange.toFixed(0);
  }

  function validerCommande(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const montantLiquidite = document.getElementById(`liquidite-${commandeId}`)?.value || 0;
    const montantOrange = document.getElementById(`orange-${commandeId}`)?.innerText || 0;
    const statutMonnaie = document.getElementById(`status-monnaie-${commandeId}`)?.value || "";

    fetch(`/commandes/valider/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `type_paiement=${type}&montant_liquidite=${montantLiquidite}&montant_orange=${montantOrange}&statut_monnaie=${statutMonnaie}`
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById(`statut-${commandeId}`).innerText = data.statut;

      if (data.avoir_cree) {
        alert(data.message_avoir);
      }

      if (!data.statut_valide && data.message_erreur) {
        alert(data.message_erreur);
      }
    });
  }
</script>
{% endblock %}

#####################################################

{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Liste des commandes</h2>

  <!-- Sélection du statut -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="btn-group" role="group" aria-label="Statut des commandes">
        <input type="radio" class="btn-check" name="statut-filter" id="en_attente" value="en_attente" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="en_attente">En attente</label>

        <input type="radio" class="btn-check" name="statut-filter" id="payer" value="payer" autocomplete="off">
        <label class="btn btn-outline-success" for="payer">Payées</label>

        <input type="radio" class="btn-check" name="statut-filter" id="impayee" value="impayee" autocomplete="off">
        <label class="btn btn-outline-danger" for="impayee">Impayées</label>
      </div>
    </div>
  </div>

  <!-- Champ de recherche -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="input-group">
        <input type="text" id="search-input" class="form-control" placeholder="Rechercher par ID, date ou nom du personnel...">
        <button class="btn btn-outline-secondary" type="button" id="search-button">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Conteneur pour les commandes -->
  <div id="commandes-container">
    {% for commande in commandes %}
    <div class="card mb-3 p-3 shadow-sm commande-card" data-statut="{{ commande.statut }}" data-id="{{ commande.id }}" data-date="{{ commande.date_commande|date:'Y-m-d' }}" data-personnel="{{ commande.personnel.nom }}">
      <h5>Commande #{{ commande.id }} - {{ commande.personnel }}</h5>
      <p><strong>Date :</strong> {{ commande.date_commande|date:"d/m/Y H:i" }}</p>
      <p>
        <strong>Statut :</strong> 
        <span id="statut-{{ commande.id }}">
          {{ commande.get_statut_display }}
        </span>
      </p>

      <!-- Liste des boissons -->
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Boisson</th>
            <th>Quantité</th>
            <th>Montant</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for item in commande.items.all %}
          <tr id="item-row-{{ item.id }}">
            <td>{{ item.boisson.nom }}</td>
            <td>
              {% if commande.statut == 'en_attente' %}
              <button class="btn btn-sm btn-secondary"
                      onclick="updateQuantity({{ item.id }}, 'decrement')">-</button>
              <span id="item-quantite-{{ item.id }}">{{ item.quantite }}</span>
              <button class="btn btn-sm btn-secondary"
                      onclick="updateQuantity({{ item.id }}, 'increment')">+</button>
              {% else %}
              <span>{{ item.quantite }}</span>
              {% endif %}
            </td>
            <td><span id="item-montant-{{ item.id }}">{{ item.montant_boisson }}</span> F</td>
            <td>
              {% if commande.statut == 'en_attente' %}
              <button class="btn btn-sm btn-danger" onclick="supprimerItem({{ item.id }})">Supprimer</button>
              {% else %}
              <span class="text-muted">-</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Ajouter une boisson (uniquement pour en attente) -->
      {% if commande.statut == 'en_attente' %}
      <div class="row mb-2">
        <div class="col">
          <select id="nouvelle-boisson-{{ commande.id }}" class="form-select">
            <option value="">-- Choisir une boisson --</option>
            {% for boisson in boissons %}
            <option value="{{ boisson.id }}">{{ boisson.nom }} - {{ boisson.prix_unitaire }} F</option>
            {% endfor %}
          </select>
        </div>
        <div class="col">
          <input type="number" id="quantite-nouvelle-{{ commande.id }}" class="form-control" placeholder="Quantité" min="1">
        </div>
        <div class="col">
          <button class="btn btn-primary" onclick="ajouterBoisson({{ commande.id }})">Ajouter</button>
        </div>
      </div>
      {% endif %}

      <p><strong>Total :</strong> <span id="commande-total-{{ commande.id }}">{{ commande.montant_total }}</span> F</p>

      <!-- Paiement (uniquement pour en attente) -->
      {% if commande.statut == 'en_attente' %}
      <label>Type de paiement :</label>
      <select id="type-paiement-{{ commande.id }}" class="form-select"
              onchange="togglePaiementFields({{ commande.id }})">
        <option value="">-- Choisir --</option>
        <option value="liquidite">Liquidité</option>
        <option value="orange_money">Orange Money</option>
        <option value="hybride">Hybride</option>
      </select>

      <div id="paiement-fields-{{ commande.id }}" class="mt-2"></div>

      <div class="mt-2">
        <button class="btn btn-success" onclick="validerCommande({{ commande.id }})">Valider</button>
        <button class="btn btn-danger" onclick="supprimerCommande({{ commande.id }})">Supprimer la commande</button>
      </div>
      {% endif %}

      <!-- Informations de paiement pour les commandes payées/impayées -->
      {% if commande.statut != 'en_attente' %}
      <div class="mt-3 p-2 bg-light rounded">
        <p><strong>Type de paiement :</strong> {{ commande.get_type_paiement_display }}</p>
        {% if commande.montant_liquidite %}
        <p><strong>Montant liquidité :</strong> {{ commande.montant_liquidite }} F</p>
        {% endif %}
        {% if commande.montant_orange %}
        <p><strong>Montant Orange Money :</strong> {{ commande.montant_orange }} F</p>
        {% endif %}
        {% if commande.montant_restant %}
        <p><strong>Montant restant :</strong> {{ commande.montant_restant }} F</p>
        {% endif %}
        {% if commande.monnaie_a_rendre %}
        <p><strong>Monnaie à rendre :</strong> {{ commande.monnaie_a_rendre }} F</p>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% empty %}
    <p id="no-commandes-message">Aucune commande pour le moment.</p>
    {% endfor %}
  </div>
</div>

<script>
  // Filtrage par statut
  document.querySelectorAll('input[name="statut-filter"]').forEach(radio => {
    radio.addEventListener('change', function() {
      filterCommandes();
    });
  });

  // Recherche
  document.getElementById('search-button').addEventListener('click', filterCommandes);
  document.getElementById('search-input').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
      filterCommandes();
    }
  });

  function filterCommandes() {
    const selectedStatut = document.querySelector('input[name="statut-filter"]:checked').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const commandes = document.querySelectorAll('.commande-card');
    let visibleCount = 0;

    commandes.forEach(card => {
      const statut = card.getAttribute('data-statut');
      const id = card.getAttribute('data-id');
      const date = card.getAttribute('data-date');
      const personnel = card.getAttribute('data-personnel').toLowerCase();

      const matchesStatut = selectedStatut === statut;
      const matchesSearch = !searchTerm || 
                           id.includes(searchTerm) || 
                           date.includes(searchTerm) || 
                           personnel.includes(searchTerm);

      if (matchesStatut && matchesSearch) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Gérer le message "Aucune commande"
    const noCommandesMessage = document.getElementById('no-commandes-message');
    if (visibleCount === 0) {
      if (!noCommandesMessage) {
        const container = document.getElementById('commandes-container');
        container.innerHTML = '<p id="no-commandes-message">Aucune commande trouvée.</p>';
      } else {
        noCommandesMessage.textContent = 'Aucune commande trouvée.';
        noCommandesMessage.style.display = 'block';
      }
    } else if (noCommandesMessage) {
      noCommandesMessage.style.display = 'none';
    }
  }

  // Initialiser le filtrage au chargement
  document.addEventListener('DOMContentLoaded', function() {
    filterCommandes();
  });

  // Les fonctions existantes restent inchangées
  function updateQuantity(itemId, action) {
    fetch(`/commandes/update-item/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (data.deleted) {
          document.getElementById(`item-row-${data.item_id}`).remove();
        } else {
          document.getElementById(`item-quantite-${data.item_id}`).innerText = data.quantite;
          document.getElementById(`item-montant-${data.item_id}`).innerText = data.item_montant;
        }
        document.getElementById(`commande-total-${data.commande_id}`).innerText = data.commande_total;
      }
    });
  }

  function togglePaiementFields(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const container = document.getElementById(`paiement-fields-${commandeId}`);
    const total = parseFloat(document.getElementById(`commande-total-${commandeId}`).innerText);

    container.innerHTML = "";

    if (type === "liquidite") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité" 
               oninput="checkMonnaie(${commandeId}, ${total})">
        <div id="monnaie-section-${commandeId}" class="mt-2" style="display:none;">
          <p><strong>Monnaie :</strong> <span id="monnaie-${commandeId}">0</span> F</p>
          <label>Status monnaie :</label>
          <select id="status-monnaie-${commandeId}" class="form-select">
            <option value="remis">Remis</option>
            <option value="avoir">Avoir</option>
          </select>
        </div>
      `;
    } else if (type === "orange_money") {
      container.innerHTML = `
        <p><strong>Montant Orange Money :</strong> ${total} F</p>
      `;
    } else if (type === "hybride") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité"
               oninput="updateOrangeHybride(${commandeId}, ${total})">
        <p><strong>Montant Orange Money :</strong> <span id="orange-${commandeId}">${total}</span> F</p>
      `;
      updateOrangeHybride(commandeId, total);
    }
  }

  function checkMonnaie(commandeId, total) {
    const montant = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const monnaieSection = document.getElementById(`monnaie-section-${commandeId}`);
    const monnaieField = document.getElementById(`monnaie-${commandeId}`);

    if (montant > total) {
      monnaieSection.style.display = "block";
      monnaieField.innerText = (montant - total).toFixed(0);
    } else {
      monnaieSection.style.display = "none";
      monnaieField.innerText = 0;
    }
  }

  function updateOrangeHybride(commandeId, total) {
    const liquidite = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const orange = Math.max(total - liquidite, 0);
    document.getElementById(`orange-${commandeId}`).innerText = orange.toFixed(0);
  }

  function validerCommande(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const montantLiquidite = document.getElementById(`liquidite-${commandeId}`)?.value || 0;
    const montantOrange = document.getElementById(`orange-${commandeId}`)?.innerText || 0;
    const statutMonnaie = document.getElementById(`status-monnaie-${commandeId}`)?.value || "";

    fetch(`/commandes/valider/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `type_paiement=${type}&montant_liquidite=${montantLiquidite}&montant_orange=${montantOrange}&statut_monnaie=${statutMonnaie}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`statut-${commandeId}`).innerText = data.statut;
        
        // Mettre à jour l'affichage selon le nouveau statut
        const commandeCard = document.querySelector(`[data-id="${commandeId}"]`);
        commandeCard.setAttribute('data-statut', data.statut_valide ? 'payer' : 'impayee');

        if (data.avoir_cree) {
          alert(data.message_avoir);
        }

        if (!data.statut_valide && data.message_erreur) {
          alert(data.message_erreur);
        }

        // Recharger la page pour mettre à jour l'affichage complet
        setTimeout(() => {
          location.reload();
        }, 1000);
      }
    });
  }

  function ajouterBoisson(commandeId) {
    const boissonId = document.getElementById(`nouvelle-boisson-${commandeId}`).value;
    const quantite = document.getElementById(`quantite-nouvelle-${commandeId}`).value || 1;

    if (!boissonId) {
      alert("Veuillez choisir une boisson.");
      return;
    }

    fetch(`/commandes/ajouter-boisson/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `boisson_id=${boissonId}&quantite=${quantite}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.message || "Erreur lors de l'ajout.");
      }
    });
  }

  function supprimerItem(itemId) {
    fetch(`/commandes/supprimer-item/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`item-row-${itemId}`).remove();
        document.getElementById(`commande-total-${data.commande_id}`).innerText = data.commande_total;
      } else {
        alert(data.message || "Erreur lors de la suppression.");
      }
    });
  }

  function supprimerCommande(commandeId) {
    if (!confirm("Voulez-vous vraiment supprimer cette commande ?")) return;

    fetch(`/commandes/supprimer-commande/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.querySelector(`[data-id="${commandeId}"]`).remove();
        filterCommandes(); // Re-filtrer après suppression
      } else {
        alert(data.message || "Erreur lors de la suppression.");
      }
    });
  }
</script>

{% endblock %}

#####################################################

{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Liste des commandes</h2>

  <!-- Sélection du statut -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="btn-group" role="group" aria-label="Statut des commandes">
        <input type="radio" class="btn-check" name="statut-filter" id="en_attente" value="en_attente" autocomplete="off" checked>
        <label class="btn btn-outline-primary" for="en_attente">En attente</label>

        <input type="radio" class="btn-check" name="statut-filter" id="payer" value="payer" autocomplete="off">
        <label class="btn btn-outline-success" for="payer">Payées</label>

        <input type="radio" class="btn-check" name="statut-filter" id="impayee" value="impayee" autocomplete="off">
        <label class="btn btn-outline-danger" for="impayee">Impayées</label>
      </div>
    </div>
  </div>

  <!-- Champ de recherche -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="input-group">
        <input type="text" id="search-input" class="form-control" placeholder="Rechercher par ID, date ou nom du personnel...">
        <button class="btn btn-outline-secondary" type="button" id="search-button">
          <i class="fas fa-search"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Conteneur pour les commandes -->
  <div id="commandes-container">
    {% for commande in commandes %}
    <div class="card mb-3 p-3 shadow-sm commande-card" data-statut="{{ commande.statut }}" data-id="{{ commande.id }}" data-date="{{ commande.date_commande|date:'Y-m-d' }}" data-personnel="{{ commande.personnel.nom }}">
      <h5>Commande #{{ commande.id }} - {{ commande.personnel }}</h5>
      <p><strong>Date :</strong> {{ commande.date_commande|date:"d/m/Y H:i" }}</p>
      <p>
        <strong>Statut :</strong> 
        <span id="statut-{{ commande.id }}">
          {{ commande.get_statut_display }}
        </span>
      </p>

      <!-- Liste des boissons -->
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Boisson</th>
            <th>Quantité</th>
            <th>Montant</th>
            {% if commande.statut == 'en_attente' %}
            <th>Actions</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for item in commande.items.all %}
          <tr id="item-row-{{ item.id }}">
            <td>{{ item.boisson.nom }}</td>
            <td>
              {% if commande.statut == 'en_attente' %}
              <button class="btn btn-sm btn-secondary"
                      onclick="updateQuantity({{ item.id }}, 'decrement')">-</button>
              <span id="item-quantite-{{ item.id }}">{{ item.quantite }}</span>
              <button class="btn btn-sm btn-secondary"
                      onclick="updateQuantity({{ item.id }}, 'increment')">+</button>
              {% else %}
              <span>{{ item.quantite }}</span>
              {% endif %}
            </td>
            <td><span id="item-montant-{{ item.id }}">{{ item.montant_boisson }}</span> F</td>
            {% if commande.statut == 'en_attente' %}
            <td>
              <button class="btn btn-sm btn-danger" onclick="supprimerItem({{ item.id }})">Supprimer</button>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- Ajouter une boisson (uniquement pour en attente) -->
      {% if commande.statut == 'en_attente' %}
      <div class="row mb-2">
        <div class="col">
          <select id="nouvelle-boisson-{{ commande.id }}" class="form-select">
            <option value="">-- Choisir une boisson --</option>
            {% for boisson in boissons %}
            <option value="{{ boisson.id }}">{{ boisson.nom }} - {{ boisson.prix_unitaire }} F</option>
            {% endfor %}
          </select>
        </div>
        <div class="col">
          <input type="number" id="quantite-nouvelle-{{ commande.id }}" class="form-control" placeholder="Quantité" min="1">
        </div>
        <div class="col">
          <button class="btn btn-primary" onclick="ajouterBoisson({{ commande.id }})">Ajouter</button>
        </div>
      </div>
      {% endif %}

      <p><strong>Total :</strong> <span id="commande-total-{{ commande.id }}">{{ commande.montant_total }}</span> F</p>

      <!-- Paiement (uniquement pour en attente) -->
      {% if commande.statut == 'en_attente' %}
      <label>Type de paiement :</label>
      <select id="type-paiement-{{ commande.id }}" class="form-select"
              onchange="togglePaiementFields({{ commande.id }})">
        <option value="">-- Choisir --</option>
        <option value="liquidite">Liquidité</option>
        <option value="orange_money">Orange Money</option>
        <option value="hybride">Hybride</option>
      </select>

      <div id="paiement-fields-{{ commande.id }}" class="mt-2"></div>

      <div class="mt-2">
        <button class="btn btn-success" onclick="validerCommande({{ commande.id }})">Valider</button>
        <button class="btn btn-danger" onclick="supprimerCommande({{ commande.id }})">Supprimer la commande</button>
      </div>
      {% endif %}

      <!-- Informations de paiement pour les commandes payées/impayées -->
      {% if commande.statut != 'en_attente' %}
      <div class="mt-3 p-2 bg-light rounded">
        <p><strong>Type de paiement :</strong> {{ commande.get_type_paiement_display }}</p>
        {% if commande.montant_liquidite %}
        <p><strong>Montant liquidité :</strong> {{ commande.montant_liquidite }} F</p>
        {% endif %}
        {% if commande.montant_orange %}
        <p><strong>Montant Orange Money :</strong> {{ commande.montant_orange }} F</p>
        {% endif %}
        {% if commande.montant_restant %}
        <p><strong>Montant restant :</strong> {{ commande.montant_restant }} F</p>
        {% endif %}
        {% if commande.monnaie_a_rendre %}
        <p><strong>Monnaie à rendre :</strong> {{ commande.monnaie_a_rendre }} F</p>
        {% endif %}
      </div>
      {% endif %}
    </div>
    {% empty %}
    <p id="no-commandes-message">Aucune commande pour le moment.</p>
    {% endfor %}
  </div>
</div>

<script>
  // Filtrage par statut
  document.querySelectorAll('input[name="statut-filter"]').forEach(radio => {
    radio.addEventListener('change', function() {
      filterCommandes();
    });
  });

  // Recherche
  document.getElementById('search-button').addEventListener('click', filterCommandes);
  document.getElementById('search-input').addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
      filterCommandes();
    }
  });

  function filterCommandes() {
    const selectedStatut = document.querySelector('input[name="statut-filter"]:checked').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const commandes = document.querySelectorAll('.commande-card');
    let visibleCount = 0;

    commandes.forEach(card => {
      const statut = card.getAttribute('data-statut');
      const id = card.getAttribute('data-id');
      const date = card.getAttribute('data-date');
      const personnel = card.getAttribute('data-personnel').toLowerCase();

      const matchesStatut = selectedStatut === statut;
      const matchesSearch = !searchTerm || 
                           id.includes(searchTerm) || 
                           date.includes(searchTerm) || 
                           personnel.includes(searchTerm);

      if (matchesStatut && matchesSearch) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

    // Gérer le message "Aucune commande"
    const noCommandesMessage = document.getElementById('no-commandes-message');
    if (visibleCount === 0) {
      if (!noCommandesMessage) {
        const container = document.getElementById('commandes-container');
        container.innerHTML = '<p id="no-commandes-message">Aucune commande trouvée.</p>';
      } else {
        noCommandesMessage.textContent = 'Aucune commande trouvée.';
        noCommandesMessage.style.display = 'block';
      }
    } else if (noCommandesMessage) {
      noCommandesMessage.style.display = 'none';
    }
  }

  // Initialiser le filtrage au chargement
  document.addEventListener('DOMContentLoaded', function() {
    filterCommandes();
  });

  // Les fonctions existantes restent inchangées
  function updateQuantity(itemId, action) {
    fetch(`/commandes/update-item/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (data.deleted) {
          document.getElementById(`item-row-${data.item_id}`).remove();
        } else {
          document.getElementById(`item-quantite-${data.item_id}`).innerText = data.quantite;
          document.getElementById(`item-montant-${data.item_id}`).innerText = data.item_montant;
        }
        document.getElementById(`commande-total-${data.commande_id}`).innerText = data.commande_total;
      }
    });
  }

  function togglePaiementFields(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const container = document.getElementById(`paiement-fields-${commandeId}`);
    const total = parseFloat(document.getElementById(`commande-total-${commandeId}`).innerText);

    container.innerHTML = "";

    if (type === "liquidite") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité" 
               oninput="checkMonnaie(${commandeId}, ${total})">
        <div id="monnaie-section-${commandeId}" class="mt-2" style="display:none;">
          <p><strong>Monnaie :</strong> <span id="monnaie-${commandeId}">0</span> F</p>
          <label>Status monnaie :</label>
          <select id="status-monnaie-${commandeId}" class="form-select">
            <option value="remis">Remis</option>
            <option value="avoir">Avoir</option>
          </select>
        </div>
      `;
    } else if (type === "orange_money") {
      container.innerHTML = `
        <p><strong>Montant Orange Money :</strong> ${total} F</p>
      `;
    } else if (type === "hybride") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité"
               oninput="updateOrangeHybride(${commandeId}, ${total})">
        <p><strong>Montant Orange Money :</strong> <span id="orange-${commandeId}">${total}</span> F</p>
      `;
      updateOrangeHybride(commandeId, total);
    }
  }

  function checkMonnaie(commandeId, total) {
    const montant = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const monnaieSection = document.getElementById(`monnaie-section-${commandeId}`);
    const monnaieField = document.getElementById(`monnaie-${commandeId}`);

    if (montant > total) {
      monnaieSection.style.display = "block";
      monnaieField.innerText = (montant - total).toFixed(0);
    } else {
      monnaieSection.style.display = "none";
      monnaieField.innerText = 0;
    }
  }

  function updateOrangeHybride(commandeId, total) {
    const liquidite = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const orange = Math.max(total - liquidite, 0);
    document.getElementById(`orange-${commandeId}`).innerText = orange.toFixed(0);
  }

  function validerCommande(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const montantLiquidite = document.getElementById(`liquidite-${commandeId}`)?.value || 0;
    const montantOrange = document.getElementById(`orange-${commandeId}`)?.innerText || 0;
    const statutMonnaie = document.getElementById(`status-monnaie-${commandeId}`)?.value || "";

    fetch(`/commandes/valider/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `type_paiement=${type}&montant_liquidite=${montantLiquidite}&montant_orange=${montantOrange}&statut_monnaie=${statutMonnaie}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`statut-${commandeId}`).innerText = data.statut;
        
        // Mettre à jour l'affichage selon le nouveau statut
        const commandeCard = document.querySelector(`[data-id="${commandeId}"]`);
        commandeCard.setAttribute('data-statut', data.statut_valide ? 'payer' : 'impayee');

        if (data.avoir_cree) {
          alert(data.message_avoir);
        }

        if (!data.statut_valide && data.message_erreur) {
          alert(data.message_erreur);
        }

        // Recharger la page pour mettre à jour l'affichage complet
        setTimeout(() => {
          location.reload();
        }, 1000);
      }
    });
  }

  function ajouterBoisson(commandeId) {
    const boissonId = document.getElementById(`nouvelle-boisson-${commandeId}`).value;
    const quantite = document.getElementById(`quantite-nouvelle-${commandeId}`).value || 1;

    if (!boissonId) {
      alert("Veuillez choisir une boisson.");
      return;
    }

    fetch(`/commandes/ajouter-boisson/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `boisson_id=${boissonId}&quantite=${quantite}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert(data.message || "Erreur lors de l'ajout.");
      }
    });
  }

  function supprimerItem(itemId) {
    fetch(`/commandes/supprimer-item/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`item-row-${itemId}`).remove();
        document.getElementById(`commande-total-${data.commande_id}`).innerText = data.commande_total;
      } else {
        alert(data.message || "Erreur lors de la suppression.");
      }
    });
  }

  function supprimerCommande(commandeId) {
    if (!confirm("Voulez-vous vraiment supprimer cette commande ?")) return;

    fetch(`/commandes/supprimer/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.querySelector(`[data-id="${commandeId}"]`).remove();
        filterCommandes(); // Re-filtrer après suppression
      } else {
        alert(data.message || "Erreur lors de la suppression.");
      }
    });
  }
</script>

{% endblock %}