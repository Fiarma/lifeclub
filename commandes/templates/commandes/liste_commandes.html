{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mt-4">
  <h2>Liste des commandes</h2>

  {% for commande in commandes %}
  <div class="card mb-3 p-3 shadow-sm">
    <h5>Commande #{{ commande.id }} - {{ commande.personnel }}</h5>
    <p>
      <strong>Statut :</strong> 
      <span id="statut-{{ commande.id }}">
        {{ commande.get_statut_display }}
      </span>
    </p>

    <!-- Liste des boissons -->
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Boisson</th>
          <th>Quantité</th>
          <th>Montant</th>
          <th>Actions</th>

        </tr>
      </thead>
       <tbody>
        {% for item in commande.items.all %}
        <tr id="item-row-{{ item.id }}">
          <td>{{ item.boisson.nom }}</td>
          <td>
            <button class="btn btn-sm btn-secondary"
                    onclick="updateQuantity({{ item.id }}, 'decrement')">-</button>
            <span id="item-quantite-{{ item.id }}">{{ item.quantite }}</span>
            <button class="btn btn-sm btn-secondary"
                    onclick="updateQuantity({{ item.id }}, 'increment')">+</button>
          </td>
          <td><span id="item-montant-{{ item.id }}">{{ item.montant_boisson }}</span> F</td>
          <td>
            <button class="btn btn-sm btn-danger" onclick="supprimerItem({{ item.id }})">Supprimer</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Ajouter une boisson -->
    <div class="row mb-2">
      <div class="col">
        <select id="nouvelle-boisson-{{ commande.id }}" class="form-select">
          <option value="">-- Choisir une boisson --</option>
          {% for boisson in boissons %}
          <option value="{{ boisson.id }}">{{ boisson.nom }} - {{ boisson.prix_unitaire }} F</option>
          {% endfor %}
        </select>
      </div>
      <div class="col">
        <input type="number" id="quantite-nouvelle-{{ commande.id }}" class="form-control" placeholder="Quantité" min="1">
      </div>
      <div class="col">
        <button class="btn btn-primary" onclick="ajouterBoisson({{ commande.id }})">Ajouter</button>
      </div>
    </div>

    <p><strong>Total :</strong> <span id="commande-total-{{ commande.id }}">{{ commande.montant_total }}</span> F</p>

    <!-- Paiement -->
    <label>Type de paiement :</label>
    <select id="type-paiement-{{ commande.id }}" class="form-select"
            onchange="togglePaiementFields({{ commande.id }})">
      <option value="">-- Choisir --</option>
      <option value="liquidite">Liquidité</option>
      <option value="orange_money">Orange Money</option>
      <option value="hybride">Hybride</option>
    </select>

    <div id="paiement-fields-{{ commande.id }}" class="mt-2"></div>
<!-- 
    <button class="btn btn-success mt-3"
            onclick="validerCommande({{ commande.id }})">Valider</button> -->
      
       <div class="mt-2">
      <button class="btn btn-success" onclick="validerCommande({{ commande.id }})">Valider</button>
      <button class="btn btn-danger" onclick="supprimerCommande({{ commande.id }})">Supprimer la commande</button>
    </div>
    
  </div>
  {% empty %}
  <p>Aucune commande pour le moment.</p>
  {% endfor %}
</div>

<script>
  function updateQuantity(itemId, action) {
    fetch(`/commandes/update-item/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `action=${action}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        if (data.deleted) {
          document.getElementById(`item-row-${data.item_id}`).remove();
        } else {
          document.getElementById(`item-quantite-${data.item_id}`).innerText = data.quantite;
          document.getElementById(`item-montant-${data.item_id}`).innerText = data.item_montant;
        }
        document.getElementById(`commande-total-${data.commande_id}`).innerText = data.commande_total;
      }
    });
  }

  function togglePaiementFields(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const container = document.getElementById(`paiement-fields-${commandeId}`);
    const total = parseFloat(document.getElementById(`commande-total-${commandeId}`).innerText);

    container.innerHTML = "";

    if (type === "liquidite") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité" 
               oninput="checkMonnaie(${commandeId}, ${total})">
        <div id="monnaie-section-${commandeId}" class="mt-2" style="display:none;">
          <p><strong>Monnaie :</strong> <span id="monnaie-${commandeId}">0</span> F</p>
          <label>Status monnaie :</label>
          <select id="status-monnaie-${commandeId}" class="form-select">
            <option value="remis">Remis</option>
            <option value="avoir">Avoir</option>
          </select>
        </div>
      `;
    } else if (type === "orange_money") {
      // Affiche le montant exact en lecture seule
      container.innerHTML = `
        <p><strong>Montant Orange Money :</strong> ${total} F</p>
      `;
    } else if (type === "hybride") {
      container.innerHTML = `
        <input type="number" id="liquidite-${commandeId}" class="form-control mt-2" placeholder="Montant liquidité"
               oninput="updateOrangeHybride(${commandeId}, ${total})">
        <p><strong>Montant Orange Money :</strong> <span id="orange-${commandeId}">${total}</span> F</p>
      `;
      // Initialise le champ Orange Money
      updateOrangeHybride(commandeId, total);
    }
  }

  function checkMonnaie(commandeId, total) {
    const montant = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const monnaieSection = document.getElementById(`monnaie-section-${commandeId}`);
    const monnaieField = document.getElementById(`monnaie-${commandeId}`);

    if (montant > total) {
      monnaieSection.style.display = "block";
      monnaieField.innerText = (montant - total).toFixed(0);
    } else {
      monnaieSection.style.display = "none";
      monnaieField.innerText = 0;
    }
  }

  function updateOrangeHybride(commandeId, total) {
    const liquidite = parseFloat(document.getElementById(`liquidite-${commandeId}`).value) || 0;
    const orange = Math.max(total - liquidite, 0);
    document.getElementById(`orange-${commandeId}`).innerText = orange.toFixed(0);
  }

  function validerCommande(commandeId) {
    const type = document.getElementById(`type-paiement-${commandeId}`).value;
    const montantLiquidite = document.getElementById(`liquidite-${commandeId}`)?.value || 0;
    const montantOrange = document.getElementById(`orange-${commandeId}`)?.innerText || 0;
    const statutMonnaie = document.getElementById(`status-monnaie-${commandeId}`)?.value || "";

    fetch(`/commandes/valider/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `type_paiement=${type}&montant_liquidite=${montantLiquidite}&montant_orange=${montantOrange}&statut_monnaie=${statutMonnaie}`
    })
    .then(response => response.json())
    .then(data => {
      document.getElementById(`statut-${commandeId}`).innerText = data.statut;

      if (data.avoir_cree) {
        alert(data.message_avoir);
      }

      if (!data.statut_valide && data.message_erreur) {
        alert(data.message_erreur);
      }
    });
  }

  ////////////////////////////////


  function ajouterBoisson(commandeId) {
    const boissonId = document.getElementById(`nouvelle-boisson-${commandeId}`).value;
    const quantite = document.getElementById(`quantite-nouvelle-${commandeId}`).value || 1;

    if (!boissonId) {
      alert("Veuillez choisir une boisson.");
      return;
    }

    fetch(`/commandes/ajouter-boisson/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `boisson_id=${boissonId}&quantite=${quantite}`
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload(); // Recharge la page pour afficher la nouvelle boisson
      } else {
        alert(data.message || "Erreur lors de l'ajout.");
      }
    });
  }

  function supprimerItem(itemId) {
    fetch(`/commandes/supprimer-item/${itemId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`item-row-${itemId}`).remove();
        document.getElementById(`commande-total-${data.commande_id}`).innerText = data.commande_total;
      } else {
        alert(data.message || "Erreur lors de la suppression.");
      }
    });
  }

  function supprimerCommande(commandeId) {
    if (!confirm("Voulez-vous vraiment supprimer cette commande ?")) return;

    fetch(`/commandes/supprimer/${commandeId}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        document.getElementById(`commande-card-${commandeId}`).remove();
      } else {
        alert(data.message || "Erreur lors de la suppression.");
      }
    });
  }
</script>


{% endblock %}
